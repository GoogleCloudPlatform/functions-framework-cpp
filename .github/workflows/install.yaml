name: install

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-ubuntu-focal:
    name: ubuntu-20.04
    runs-on: ubuntu-20.04
    steps:
      - name: install ninja
        run: sudo apt install ninja-build
      - uses: actions/checkout@v2
      - name: cache-vcpkg
        id: cache-vcpkg
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/vcpkg
          key: |
            vcpkg-${{ runner.os }}-${{ github.job }}-${{ hashFiles(
                '/usr/local/share/vcpkg/**/vcpkg.json',
                '/usr/local/share/vcpkg/**/CONTROL',
                'vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ github.job }}-
            vcpkg-${{ runner.os }}-
      - name: configure
        run: >
          cmake -S . -B ${{runner.temp}}/build -GNinja -DBUILD_TESTING=OFF
          -DCMAKE_INSTALL_PREFIX=${{runner.temp}}/staging
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          -DCMAKE_TOOLCHAIN_FILE=/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake
      - name: build
        run: cmake --build ${{runner.temp}}/build
      - name: install
        run: cmake --build ${{runner.temp}}/build --target install
      - name: create-overlay
        # We want to test with the *current* version of
        # `functions-framework-cpp`, not with the version published by vcpkg.
        # One can do that by creating an vcpkg overlay.
        run: >
          mkdir -p "${{runner.temp}}/quickstart/vcpkg-overlays" &&
          cp build_scripts/vcpkg-overlays/* "${{runner.temp}}/quickstart/vcpkg-overlays" &&
          sed -i -e "s;/usr/local/share/gcf;${{github.workspace}};" \
            ${{runner.temp}}/quickstart/vcpkg-overlays/portfile.cmake
      - name: test-configure
        env:
          VCPKG_OVERLAY_PORTS: "${{runner.temp}}/quickstart/vcpkg-overlays"
        run: >
          cmake -S google/cloud/functions/quickstart -B "${{runner.temp}}/quickstart/build" -GNinja
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          -DCMAKE_TOOLCHAIN_FILE=/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake
      - name: test-build
        run: cmake --build ${{runner.temp}}/quickstart/build

  build-ubuntu-focal-shared:
    name: ubuntu-20.04-shared
    runs-on: ubuntu-20.04
    steps:
      - name: install-dependencies
        run: sudo apt install ninja-build libboost-dev libboost-program-options-dev nlohmann-json3-dev
      - name: install-abseil
        run: >
          curl -sSL https://github.com/abseil/abseil-cpp/archive/20200225.2.tar.gz |
          tar -xzf - --strip-components=1 &&
          sed -i 's/^#define ABSL_OPTION_USE_\(.*\) 1/#define ABSL_OPTION_USE_\1 0/' "absl/base/options.h" &&
          cmake -GNinja -DCMAKE_BUILD_TYPE="Release" -DBUILD_TESTING=OFF -DBUILD_SHARED_LIBS=yes -H. -Bcmake-out/abseil &&
          cmake --build cmake-out/abseil &&
          sudo cmake --build cmake-out/abseil --target install &&
          sudo ldconfig
      - uses: actions/checkout@v2
      - name: configure
        run: >
          cmake -S . -B ${{runner.temp}}/build -GNinja
          -DBUILD_TESTING=OFF -DBUILD_SHARED_LIBS=ON
          -DCMAKE_INSTALL_PREFIX=${{runner.temp}}/staging
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
      - name: build
        run: cmake --build ${{runner.temp}}/build
      - name: install
        run: cmake --build ${{runner.temp}}/build --target install
      - name: create-overlay
        # We want to test with the *current* version of
        # `functions-framework-cpp`, not with the version published by vcpkg.
        # One can do that by creating an vcpkg overlay.
        run: >
          mkdir -p "${{runner.temp}}/quickstart/vcpkg-overlays" &&
          cp build_scripts/vcpkg-overlays/* "${{runner.temp}}/quickstart/vcpkg-overlays" &&
          sed -i -e "s;/usr/local/share/gcf;${{github.workspace}};" \
            ${{runner.temp}}/quickstart/vcpkg-overlays/portfile.cmake
      - name: test-configure
        env:
          VCPKG_OVERLAY_PORTS: "${{runner.temp}}/quickstart/vcpkg-overlays"
        run: >
          cmake -S google/cloud/functions/quickstart -B "${{runner.temp}}/quickstart/build" -GNinja
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON
          -DCMAKE_TOOLCHAIN_FILE=/usr/local/share/vcpkg/scripts/buildsystems/vcpkg.cmake
      - name: test-build
        run: cmake --build ${{runner.temp}}/quickstart/build
