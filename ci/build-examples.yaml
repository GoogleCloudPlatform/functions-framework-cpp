# WARNING: DO NOT EDIT THIS FILE
# This file is automatically generated by ci/generate-build-examples.sh
timeout: 3600s
options:
  machineType: 'N1_HIGHCPU_32'
  diskSizeGb: '512'

steps:
  # Generally we prefer to create container images with local names, to avoid
  # polluting the repository and/or having conflicts with other builds. The
  # exception are images created by kaniko and any images pushed to GCR
  # to deploy on Cloud Run.
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'pack', '-f', 'build_scripts/pack.Dockerfile', 'build_scripts']

  # Create the docker images for the buildpacks builder.
  - name: 'gcr.io/kaniko-project/executor:v1.6.0-debug'
    args: [
        "--context=dir:///workspace/",
        "--dockerfile=build_scripts/Dockerfile",
        "--cache=true",
        "--cache-repo=gcr.io/${PROJECT_ID}/ci/cache",
        "--target=gcf-cpp-runtime",
        "--destination=gcr.io/${PROJECT_ID}/ci/run-image:${BUILD_ID}",
    ]
    waitFor: ['-']
    timeout: 1800s
  - name: 'gcr.io/cloud-builders/docker'
    args: ['pull', 'gcr.io/${PROJECT_ID}/ci/run-image:${BUILD_ID}']

  - name: 'gcr.io/kaniko-project/executor:v1.6.0-debug'
    args: [
        "--context=dir:///workspace/",
        "--dockerfile=build_scripts/Dockerfile",
        "--cache=true",
        "--cache-repo=gcr.io/${PROJECT_ID}/ci/cache",
        "--target=gcf-cpp-ci",
        "--destination=gcr.io/${PROJECT_ID}/ci/build-image:${BUILD_ID}",
    ]
    waitFor: ['-']
    timeout: 1800s
  - name: 'gcr.io/cloud-builders/docker'
    args: ['pull', 'gcr.io/${PROJECT_ID}/ci/build-image:${BUILD_ID}']

    # Setup local names for the builder images.
  - name: 'gcr.io/cloud-builders/docker'
    args: ['tag', 'gcr.io/${PROJECT_ID}/ci/build-image:${BUILD_ID}', 'ci-build-image:latest']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['tag', 'gcr.io/${PROJECT_ID}/ci/run-image:${BUILD_ID}', 'ci-run-image:latest']

  # Create the buildpacks builder, and make it the default.
  - name: 'pack'
    args: ['builder', 'create', 'gcf-cpp-builder:bionic', '--config', 'ci/pack/builder.toml', ]
  - name: 'pack'
    args: ['config', 'trusted-builders', 'add', 'gcf-cpp-builder:bionic', ]
  - name: 'pack'
    args: ['config', 'default-builder', 'gcf-cpp-builder:bionic', ]
    id: 'gcf-builder-ready'

  # Build the examples using the builder. Keep these in alphabetical order.
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-cloud-event'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=HelloCloudEvent',
      '--path', 'examples/hello_cloud_event',
      'hello-cloud-event',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-from-namespace'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=hello_from_namespace::HelloWorld',
      '--path', 'examples/hello_from_namespace',
      'hello-from-namespace',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-from-namespace-rooted'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=::hello_from_namespace::HelloWorld',
      '--path', 'examples/hello_from_namespace',
      'hello-from-namespace-rooted',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-from-nested-namespace'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=hello_from_nested_namespace::ns0::ns1::HelloWorld',
      '--path', 'examples/hello_from_nested_namespace',
      'hello-from-nested-namespace',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-multiple-sources'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=HelloMultipleSources',
      '--path', 'examples/hello_multiple_sources',
      'hello-multiple-sources',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-gcs'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=HelloGcs',
      '--path', 'examples/hello_gcs',
      'hello-gcs',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-with-third-party'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=HelloWithThirdParty',
      '--path', 'examples/hello_with_third_party',
      'hello-with-third-party',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-world'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=HelloWorld',
      '--path', 'examples/hello_world',
      'hello-world',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'hello-world-rooted'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=::HelloWorld',
      '--path', 'examples/hello_world',
      'hello-world-rooted',
    ]

  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'howto-use-legacy-code'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=HowtoUseLegacyCode',
      '--path', 'examples/howto_use_legacy_code',
      'howto-use-legacy-code',
    ]

  # Build the cloud site examples.
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-bearer_token'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=bearer_token',
      '--path', 'examples/site/bearer_token',
      'site-bearer_token',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-concepts_after_response'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=concepts_after_response',
      '--path', 'examples/site/concepts_after_response',
      'site-concepts_after_response',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-concepts_after_timeout'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=concepts_after_timeout',
      '--path', 'examples/site/concepts_after_timeout',
      'site-concepts_after_timeout',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-concepts_filesystem'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=concepts_filesystem',
      '--path', 'examples/site/concepts_filesystem',
      'site-concepts_filesystem',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-concepts_request'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=concepts_request',
      '--path', 'examples/site/concepts_request',
      'site-concepts_request',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-concepts_stateless'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=concepts_stateless',
      '--path', 'examples/site/concepts_stateless',
      'site-concepts_stateless',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-env_vars'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=env_vars',
      '--path', 'examples/site/env_vars',
      'site-env_vars',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-hello_world_error'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=hello_world_error',
      '--path', 'examples/site/hello_world_error',
      'site-hello_world_error',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-hello_world_get'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=hello_world_get',
      '--path', 'examples/site/hello_world_get',
      'site-hello_world_get',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-hello_world_http'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=hello_world_http',
      '--path', 'examples/site/hello_world_http',
      'site-hello_world_http',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-hello_world_pubsub'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=hello_world_pubsub',
      '--path', 'examples/site/hello_world_pubsub',
      'site-hello_world_pubsub',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-hello_world_storage'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=hello_world_storage',
      '--path', 'examples/site/hello_world_storage',
      'site-hello_world_storage',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-http_content'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=http_content',
      '--path', 'examples/site/http_content',
      'site-http_content',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-http_cors'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=http_cors',
      '--path', 'examples/site/http_cors',
      'site-http_cors',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-http_cors_auth'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=http_cors_auth',
      '--path', 'examples/site/http_cors_auth',
      'site-http_cors_auth',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-http_form_data'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=http_form_data',
      '--path', 'examples/site/http_form_data',
      'site-http_form_data',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-http_method'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=http_method',
      '--path', 'examples/site/http_method',
      'site-http_method',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-http_xml'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=http_xml',
      '--path', 'examples/site/http_xml',
      'site-http_xml',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-log_helloworld'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=log_helloworld',
      '--path', 'examples/site/log_helloworld',
      'site-log_helloworld',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-log_stackdriver'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=log_stackdriver',
      '--path', 'examples/site/log_stackdriver',
      'site-log_stackdriver',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-pubsub_subscribe'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=pubsub_subscribe',
      '--path', 'examples/site/pubsub_subscribe',
      'site-pubsub_subscribe',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tips_gcp_apis'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=tips_gcp_apis',
      '--path', 'examples/site/tips_gcp_apis',
      'site-tips_gcp_apis',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tips_infinite_retries'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=tips_infinite_retries',
      '--path', 'examples/site/tips_infinite_retries',
      'site-tips_infinite_retries',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tips_lazy_globals'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=tips_lazy_globals',
      '--path', 'examples/site/tips_lazy_globals',
      'site-tips_lazy_globals',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tips_retry'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=cloudevent',
      '--env', 'TARGET_FUNCTION=tips_retry',
      '--path', 'examples/site/tips_retry',
      'site-tips_retry',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tips_scopes'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=tips_scopes',
      '--path', 'examples/site/tips_scopes',
      'site-tips_scopes',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tutorial_cloud_bigtable'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=tutorial_cloud_bigtable',
      '--path', 'examples/site/tutorial_cloud_bigtable',
      'site-tutorial_cloud_bigtable',
    ]
  - name: 'pack'
    waitFor: ['gcf-builder-ready']
    id: 'site-tutorial_cloud_spanner'
    args: ['build',
      '--env', 'FUNCTION_SIGNATURE_TYPE=http',
      '--env', 'TARGET_FUNCTION=tutorial_cloud_spanner',
      '--path', 'examples/site/tutorial_cloud_spanner',
      'site-tutorial_cloud_spanner',
    ]

  # Verify generated images are deployable
  - name: 'gcr.io/cloud-builders/docker'
    waitFor: ['hello-world']
    args: ['tag', 'hello-world', 'gcr.io/${PROJECT_ID}/ci/hello-world:${BUILD_ID}']
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/${PROJECT_ID}/ci/hello-world:${BUILD_ID}']
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'run', 'deploy',
      'hello-world-${BUILD_ID}',
      '--platform', 'managed',
      '--project', '${PROJECT_ID}',
      '--region', 'us-central1',
      '--image', 'gcr.io/${PROJECT_ID}/ci/hello-world:${BUILD_ID}',
      '--allow-unauthenticated',
    ]
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        URL=$$(gcloud run services list \
            --project=${PROJECT_ID} \
            --platform managed \
            --filter=SERVICE:hello-world-${BUILD_ID} \
            '--format=csv[no-heading](URL)')
        echo "Pinging service at $${URL}"
        curl -sSL --retry 3 "$${URL}"
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'run', 'services', 'delete',
      'hello-world-${BUILD_ID}',
      '--platform', 'managed',
      '--project', '${PROJECT_ID}',
      '--region', 'us-central1',
      '--quiet',
    ]

  # Remove the images created by this build.
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set +e
        gcloud container images delete -q gcr.io/${PROJECT_ID}/ci/run-image:${BUILD_ID}
        gcloud container images delete -q gcr.io/${PROJECT_ID}/ci/build-image:${BUILD_ID}
        gcloud container images delete -q gcr.io/${PROJECT_ID}/ci/hello-world:${BUILD_ID}
        exit 0

  # The previous step may not run if the build fails. Garbage collect any
  # images created by this script more than 4 weeks ago. This step should
  # not break the build on error, and it can start running as soon as the
  # build does.
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        set +e
        for image in hello-world build-image run-image cache; do
          gcloud --project=${PROJECT_ID} container images list-tags gcr.io/${PROJECT_ID}/ci/$${image} \
              --format='get(digest)' --filter='timestamp.datetime < -P4W' | \
          xargs printf "gcr.io/${PROJECT_ID}/$${image}@$$1\n"
        done | \
        xargs -P 4 -L 32 gcloud container images delete -q --force-delete-tags
        exit 0
